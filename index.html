const NewOrderForm = () => {
    const [newOrder, setNewOrder] = useState({
        department: 'Sales',
        submittedBy: '',
        capexNumber: '',
        prNumber: '',
        poNumber: '',
        description: '',
        lineItems: [{ Material: '', quantity: '', totalPrice: '', costCenter: '', designatedTo: '' }]
    });

    const addLineItem = () => {
        setNewOrder(prev => ({
            ...prev,
            lineItems: [...prev.lineItems, { Material: '', quantity: '', totalPrice: '', costCenter: '', designatedTo: '' }]
        }));
    };

    const updateLineItem = (index, field, value) => {
        setNewOrder(prev => ({
            ...prev,
            lineItems: prev.lineItems.map((item, i) => 
                i === index ? { ...item, [field]: value } : item
            )
        }));
    };

    const submitOrder = () => {
        const orderId = `ORD-2024-${String(orders.length + 1).padStart(3, '0')}`;
        const capexId = newOrder.capexNumber;
        const prNumber = newOrder.prNumber || `PR-2024-${String(orders.length + 1).padStart(3, '0')}`;
        const currentUser = newOrder.submittedBy;
        const timestamp = new Date().toISOString();
        
        const processedLineItems = newOrder.lineItems.map((item, index) => ({
            id: `LI-${String(orders.length * 10 + index + 1).padStart(3, '0')}`,
            Material: item.Material,
            quantity: parseInt(item.quantity),
            totalPrice: parseFloat(item.totalPrice),
            costCenter: item.costCenter,
            designatedTo: item.designatedTo,
            status: 'CapEx Submitted - PR Pending',
            statusHistory: [
                { status: 'CapEx Submitted - PR Pending', timestamp, updatedBy: currentUser }
            ]
        }));

        const order = {
            id: orderId,
            capexId: capexId,
            prNumber: prNumber,
            poNumber: newOrder.poNumber || '',
            department: newOrder.department,
            submittedBy: newOrder.submittedBy,
            submittedDate: new Date().toISOString().split('T')[0],
            description: newOrder.description,
            status: 'CapEx Submitted - PR Pending',
            totalAmount: processedLineItems.reduce((sum, item) => sum + item.totalPrice, 0),
            lineItems: processedLineItems
        };

        setOrders(prev => [...prev, order]);
        setShowNewOrderForm(false);
        setNewOrder({
            department: 'Sales',
            submittedBy: '',
            capexNumber: '',
            prNumber: '',
            poNumber: '',
            description: '',
            lineItems: [{ Material: '', quantity: '', totalPrice: '', costCenter: '', designatedTo: '' }]
        });
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <h2 className="text-xl font-bold mb-4">Create New Order</h2>
                
                <div className="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label className="block text-sm font-medium mb-2">Department</label>
                        <select 
                            value={newOrder.department}
                            onChange={(e) => setNewOrder(prev => ({ ...prev, department: e.target.value }))}
                            className="w-full p-2 border rounded-lg"
                        >
                            <option value="Sales">Sales</option>
                            <option value="MASC">MASC</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Submitted By</label>
                        <input 
                            type="text"
                            value={newOrder.submittedBy}
                            onChange={(e) => setNewOrder(prev => ({ ...prev, submittedBy: e.target.value }))}
                            className="w-full p-2 border rounded-lg"
                            placeholder="Enter your name"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">CapEx Number *</label>
                        <input 
                            type="text"
                            value={newOrder.capexNumber}
                            onChange={(e) => setNewOrder(prev => ({ ...prev, capexNumber: e.target.value }))}
                            className="w-full p-2 border rounded-lg"
                            placeholder="Enter CapEx number"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">PR Number</label>
                        <input 
                            type="text"
                            value={newOrder.prNumber}
                            onChange={(e) => setNewOrder(prev => ({ ...prev, prNumber: e.target.value }))}
                            className="w-full p-2 border rounded-lg"
                            placeholder="Enter PR number"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">PO Number</label>
                        <input 
                            type="text"
                            value={newOrder.poNumber}
                            onChange={(e) => setNewOrder(prev => ({ ...prev, poNumber: e.target.value }))}
                            className="w-full p-2 border rounded-lg"
                            placeholder="Enter PO number"
                        />
                    </div>
                </div>

                <div className="mb-6">
                    <label className="block text-sm font-medium mb-2">Description</label>
                    <textarea 
                        value={newOrder.description}
                        onChange={(e) => setNewOrder(prev => ({ ...prev, description: e.target.value }))}
                        className="w-full p-2 border rounded-lg"
                        placeholder="Enter order description..."
                        rows="3"
                    />
                </div>

                <h3 className="font-semibold mb-3">Line Items</h3>
                {newOrder.lineItems.map((item, index) => (
                    <div key={index} className="grid grid-cols-5 gap-3 mb-3 p-3 border rounded-lg">
                        <div>
                            <label className="block text-sm font-medium mb-1">Material</label>
                            <input 
                                type="text"
                                value={item.Material}
                                onChange={(e) => updateLineItem(index, 'Material', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Item Material"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Quantity</label>
                            <input 
                                type="number"
                                value={item.quantity}
                                onChange={(e) => updateLineItem(index, 'quantity', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Qty"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Total Price</label>
                            <input 
                                type="number"
                                value={item.totalPrice}
                                onChange={(e) => updateLineItem(index, 'totalPrice', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Total"
                                step="0.01"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Cost Center</label>
                            <input 
                                type="text"
                                value={item.costCenter}
                                onChange={(e) => updateLineItem(index, 'costCenter', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Cost center"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Designated To</label>
                            <input 
                                type="text"
                                value={item.designatedTo}
                                onChange={(e) => updateLineItem(index, 'designatedTo', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Designated to"
                            />
                        </div>
                    </div>
                ))}
                
                <button 
                    onClick={addLineItem}
                    className="mb-6 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2"
                >
                    <Plus />
                    Add Line Item
                </button>

                <div className="flex justify-end space-x-3">
                    <button 
                        onClick={() => setShowNewOrderForm(false)}
                        className="px-4 py-2 border rounded-lg hover:bg-gray-50"
                    >
                        Cancel
                    </button>
                    <button 
                        onClick={submitOrder}
                        className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                        disabled={
                            !newOrder.submittedBy || 
                            !newOrder.capexNumber || 
                            newOrder.lineItems.some(item => !item.Material || !item.quantity || !item.totalPrice)
                        }
                    >
                        Submit Order
                    </button>
                </div>
            </div>
        </div>
    );
};
